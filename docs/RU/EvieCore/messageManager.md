[[Назад]](./main.md)

# MessageManager <span style="font-size: 10px">[EvieCore/module]</span>

## Описание 
**MessageManager**  — это класс для управления системой сообщений и подписчиков в Unity. Он позволяет подписываться и отписываться от сообщений, а также отправлять их с различными типами данных (или без них). Система сообщений реализована через словарь, где каждому сообщению соответствует делегат, хранящий список подписчиков.
Вместо прямых вызовов между объектами, сообщения обеспечивают более гибкую архитектуру, позволяя объектам взаимодействовать между собой без явных ссылок друг на друга. Это помогает снизить связность между компонентами и облегчить тестирование.

### Особенности: 

- Подача сообщений происходит через строковый ключ, который является идентификатором.

- Подписчики могут быть различных типов (без параметров и с параметрами).
 
- Обработка сообщений реализована через делегаты (`Action` и `Action<T>`).

- Можно подписываться на сообщения и удалять подписки в любое время.

- Внимание: использование сообщений требует осторожности, так как это может привести к сильной связанности и трудности отладки в сложных системах.

## Классы и Интерфейсы 

### Классы: 
 
1. **MessageManager** 
Это основной класс, управляющий подписками и отправкой сообщений. Он реализует паттерн одиночки (Singleton), что позволяет работать с ним через одно глобальное вхождение `MessageManager.Instance`.

### Методы: 
 
1. **`Awake`** 
Инициализирует экземпляр класса и присваивает его глобальной переменной `Instance`. Если объект уже существует, текущий объект уничтожается.
 
2. **`Subscribe(string message, Action listener)`** 
Подписывается на сообщение без параметров. Добавляет переданный делегат (слушателя) к сообщению.
 
3. **`Unsubscribe(string message, Action listener)`** 
Отписывается от сообщения без параметров. Удаляет переданный делегат (слушателя) из списка подписчиков.
 
4. **`Subscribe<T>(string message, Action<T> listener)`** 
Подписывается на сообщение с одним параметром типа `T`. Добавляет переданный делегат (слушателя) для сообщений с параметрами типа `T`.
 
5. **`Unsubscribe<T>(string message, Action<T> listener)`** 
Отписывается от сообщения с параметром типа `T`. Удаляет переданный делегат (слушателя) из списка подписчиков для сообщений с параметром типа `T`.
 
6. **`SendMessage(string message)`** 
Отправляет сообщение без параметров. Все подписчики, подписавшиеся на это сообщение, будут вызваны.
 
7. **`SendMessage<T>(string message, T arg)`** 
Отправляет сообщение с параметром типа `T`. Все подписчики, подписавшиеся на это сообщение с соответствующим типом, будут вызваны с переданным аргументом.

### Делегаты: 
 
- **Action**  — делегат для сообщений без параметров.
 
- **Action\<T>**  — делегат для сообщений с параметрами типа `T`.

## Пример использования 


```csharp
using UnityEngine;

public class ExampleUsage : MonoBehaviour
{
    private void Start()
    {
        // Подписываемся на сообщения
        MessageManager.Instance.Subscribe("OnGameStart", OnGameStart);
        MessageManager.Instance.Subscribe<int>("OnScoreChanged", OnScoreChanged);

        // Отправляем сообщения
        MessageManager.Instance.SendMessage("OnGameStart");
        MessageManager.Instance.SendMessage("OnScoreChanged", 100);
    }

    private void OnGameStart()
    {
        Debug.Log("Игра началась!");
    }

    private void OnScoreChanged(int newScore)
    {
        Debug.Log($"Новый счёт: {newScore}");
    }

    private void OnDestroy()
    {
        // Отписываемся от сообщений при уничтожении объекта
        MessageManager.Instance.Unsubscribe("OnGameStart", OnGameStart);
        MessageManager.Instance.Unsubscribe<int>("OnScoreChanged", OnScoreChanged);
    }
}
```

### Объяснение примера: 
 
1. В методе `Start` происходит подписка на два сообщения: `"OnGameStart"` (без параметров) и `"OnScoreChanged"` (с параметром типа `int`).
 
2. Сообщения отправляются с помощью методов `SendMessage`: 
  - Для `OnGameStart` сообщение отправляется без параметров.
 
  - Для `OnScoreChanged` передается параметр типа `int`, который выводится в консоль.
 
3. В методе `OnDestroy` происходят отписки от этих сообщений, чтобы предотвратить утечки памяти или нежелательное поведение, когда объект уничтожается.

## Заключение 
**MessageManager**  предоставляет удобный механизм для организации событийной системы в Unity, что позволяет уменьшить прямые зависимости между компонентами. Однако важно помнить, что чрезмерное использование системы сообщений может привести к трудностям в поддержке и отладке кода, особенно в больших проектах. Поэтому следует применять такую систему с осторожностью и только в тех случаях, когда она действительно оправдана.
Лучше всего использовать её для систем, где компоненты должны взаимодействовать с минимальными зависимостями (например, UI, системы сообщений и т.д.), но при этом избегать её в частых вызовах между основными игровыми объектами, чтобы не снизить читаемость и тестируемость кода.